<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METEFLIX</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Estilos Globais -->
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        body { background-color: #141414; color: white; font-family: sans-serif; overflow-x: hidden; margin: 0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        /* Ajuste para o iframe do Google Sites ocupar altura total */
        html, body, #root { height: 100%; }
    </style>

    <!-- Import Map para dependências -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.0",
        "@google/genai": "https://esm.sh/@google/genai@0.1.0"
      }
    }
    </script>

    <!-- Babel Standalone para rodar JSX/TSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { GoogleGenAI, Type } from "@google/genai";
        import { 
            Loader2, ChevronLeft, PlayCircle, Menu, X, AlertCircle, 
            Sparkles, FolderPlus, Video, Upload, Link as LinkIcon, 
            FileVideo, Edit2, Trash2, Save, RotateCcw, PlusCircle, Image, Code 
        } from 'lucide-react';

        // ------------------------------------------------------------------
        // 1. CONFIGURAÇÕES (SUPABASE & GEMINI)
        // ------------------------------------------------------------------
        
        // Configuração Supabase
        const supabaseUrl = 'https://ctgnxnjqtciqqjlbjrvn.supabase.co';
        const supabaseKey = 'sb_publishable_UtZByjbz2vpnUurJaYcixw_ZyQobsqL';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Configuração Gemini
        // ATENÇÃO: Substitua a string abaixo pela sua API KEY real do Google AI Studio
        // No Google Sites, não existe process.env, então a chave deve estar aqui.
        const GEMINI_API_KEY = 'SUA_CHAVE_GEMINI_AQUI'; 
        
        const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });

        // ------------------------------------------------------------------
        // 2. TYPES
        // ------------------------------------------------------------------
        interface Lesson {
            id: string;
            title: string;
            description: string;
            videoUrl: string;
            duration: string;
            thumbnail?: string;
        }

        interface Module {
            id: string;
            title: string;
            lessons: Lesson[];
        }

        interface Course {
            id: string;
            title: string;
            description: string;
            thumbnail: string;
            heroImage?: string;
            tags: string[];
            modules: Module[];
        }

        enum ViewState {
            HOME = 'HOME',
            PLAYER = 'PLAYER',
            ADMIN = 'ADMIN'
        }

        interface PlayerState {
            courseId: string;
            moduleId: string;
            lessonId: string;
        }

        // ------------------------------------------------------------------
        // 3. SERVICES
        // ------------------------------------------------------------------
        const generateLessonDetails = async (title: string, context: string) => {
            if (GEMINI_API_KEY === 'SUA_CHAVE_GEMINI_AQUI') {
                alert("Configure a API Key do Gemini no código HTML!");
                return { description: "Configure a API Key.", durationEstimate: "00:00", tags: [] };
            }
            try {
                const prompt = `
                Create metadata for an online course lesson titled "${title}".
                Context of the course: ${context}.
                Please provide:
                1. A catchy, professional description (max 300 characters) in Portuguese.
                2. An estimated duration (e.g., "10:00").
                3. A list of 3 relevant tags.
                `;

                const response = await ai.models.generateContent({
                    model: 'gemini-1.5-flash', // Usando modelo estável para o script standalone
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                description: { type: Type.STRING },
                                durationEstimate: { type: Type.STRING },
                                tags: { type: Type.ARRAY, items: { type: Type.STRING } }
                            },
                            required: ["description", "durationEstimate", "tags"]
                        }
                    }
                });

                const result = JSON.parse(response.text() || '{}');
                return {
                    description: result.description || "Descrição não disponível.",
                    durationEstimate: result.durationEstimate || "05:00",
                    tags: result.tags || ["Curso", "Online"]
                };
            } catch (error) {
                console.error("Gemini API Error:", error);
                return {
                    description: "Adicione uma descrição manual.",
                    durationEstimate: "00:00",
                    tags: ["Geral"]
                };
            }
        };

        // ------------------------------------------------------------------
        // 4. COMPONENTS
        // ------------------------------------------------------------------

        // --- Hero Component ---
        const Hero = ({ course }) => {
            return (
                <div className="relative h-[60vh] md:h-[80vh] w-full">
                    <div className="absolute inset-0">
                        <img 
                            src={course.heroImage || course.thumbnail} 
                            alt={course.title}
                            className="w-full h-full object-cover"
                        />
                        <div className="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-transparent" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent" />
                    </div>
                    <div className="relative z-10 flex flex-col justify-center h-full px-8 md:px-16 max-w-4xl">
                        <h1 className="text-4xl md:text-6xl font-black text-white drop-shadow-lg leading-tight mb-4">
                            {course.title.toUpperCase()}
                        </h1>
                        <p className="text-lg md:text-xl text-gray-200 mb-8 drop-shadow-md line-clamp-3 max-w-2xl">
                            {course.description}
                        </p>
                    </div>
                </div>
            );
        };

        // --- CourseRow Component ---
        const CourseRow = ({ title, items, moduleId, onSelectLesson }) => {
            return (
                <div className="mb-8 px-4 md:px-16">
                    <h2 className="text-xl md:text-2xl font-bold text-white mb-4 hover:text-red-500 transition-colors cursor-pointer inline-block">
                        {title}
                    </h2>
                    <div className="relative group">
                        <div className="flex gap-4 overflow-x-auto overflow-y-hidden pb-4 hide-scroll scroll-smooth">
                            {items.map((lesson, index) => (
                                <div 
                                    key={lesson.id} 
                                    className="flex-none w-64 md:w-80 cursor-pointer relative transition-transform duration-300 hover:scale-105 hover:z-10"
                                    onClick={() => onSelectLesson(moduleId, lesson.id)}
                                >
                                    <div className="relative aspect-video bg-zinc-800 rounded-md overflow-hidden">
                                        <img 
                                            src={lesson.thumbnail || `https://picsum.photos/seed/${lesson.id}/400/225`} 
                                            alt={lesson.title}
                                            className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                        />
                                        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-700">
                                            <div className="h-full bg-red-600 w-1/3" /> 
                                        </div>
                                        <div className="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 bg-black/40 transition-opacity">
                                            <PlayCircle size={48} className="text-white" />
                                        </div>
                                    </div>
                                    <div className="mt-2 p-1">
                                        <h3 className="text-sm font-bold text-white truncate">{index + 1}. {lesson.title}</h3>
                                        <p className="text-xs text-gray-400 mt-1 line-clamp-2">{lesson.description}</p>
                                        <span className="text-xs text-zinc-500 mt-1 block">{lesson.duration}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VideoPlayer Component ---
        const VideoPlayer = ({ course, initialModuleId, initialLessonId, onBack, onNavigate }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(true);
            const [currentModuleId, setCurrentModuleId] = useState(initialModuleId);
            const [currentLessonId, setCurrentLessonId] = useState(initialLessonId);

            useEffect(() => {
                setCurrentModuleId(initialModuleId);
                setCurrentLessonId(initialLessonId);
            }, [initialModuleId, initialLessonId]);

            const currentModule = course.modules.find(m => m.id === currentModuleId);
            const currentLesson = currentModule?.lessons.find(l => l.id === currentLessonId);

            if (!currentLesson || !currentModule) return <div className="text-white flex items-center justify-center h-screen">Aula não encontrada</div>;

            const isEmbedCode = (url) => url.trim().startsWith('<');
            const getYouTubeId = (url) => {
                if (!url) return null;
                const pattern = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                const match = url.match(pattern);
                return match ? match[1] : null;
            };

            const renderVideoContent = () => {
                const url = currentLesson.videoUrl;
                if (isEmbedCode(url)) {
                    return <div className="w-full h-full flex items-center justify-center bg-black" dangerouslySetInnerHTML={{ __html: url }} />;
                }
                const youtubeId = getYouTubeId(url);
                if (youtubeId) {
                    return (
                        <iframe
                            key={youtubeId}
                            width="100%" height="100%"
                            src={`https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0&modestbranding=1&origin=${window.location.origin}`}
                            title={currentLesson.title}
                            frameBorder="0" allowFullScreen
                            className="w-full h-full object-contain"
                        />
                    );
                }
                return (
                    <video key={url} controls autoPlay className="w-full h-full object-contain" src={url}>
                        <div className="flex flex-col items-center justify-center h-full text-white">
                            <AlertCircle size={48} className="mb-4 text-red-600" />
                            <p>Formato não suportado: {url}</p>
                        </div>
                    </video>
                );
            };

            return (
                <div className="flex h-screen bg-black overflow-hidden relative">
                    <div className={`flex-1 flex flex-col transition-all duration-300 ${isSidebarOpen ? 'mr-80' : 'mr-0'}`}>
                        <div className="absolute top-0 left-0 right-0 p-4 z-20 flex items-center justify-between bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                            <button onClick={onBack} className="flex items-center text-white hover:text-red-600 transition-colors pointer-events-auto">
                                <ChevronLeft size={24} /> <span className="ml-2 font-bold text-lg">Voltar</span>
                            </button>
                            <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="text-white hover:text-gray-300 p-2 rounded-full bg-black/50 backdrop-blur-sm pointer-events-auto">
                                {isSidebarOpen ? <X size={24} /> : <Menu size={24} />}
                            </button>
                        </div>
                        <div className="flex-1 bg-black flex items-center justify-center relative overflow-hidden">
                            {renderVideoContent()}
                        </div>
                        <div className="p-6 bg-zinc-900 border-t border-zinc-800 z-10 shrink-0">
                            <h1 className="text-2xl font-bold text-white mb-2">{currentLesson.title}</h1>
                            <p className="text-gray-400 max-w-4xl">{currentLesson.description}</p>
                        </div>
                    </div>
                    <div className={`fixed right-0 top-0 bottom-0 w-80 bg-zinc-900 border-l border-zinc-800 transform transition-transform duration-300 z-30 flex flex-col ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="p-5 border-b border-zinc-800 bg-zinc-900 z-10">
                            <h2 className="text-lg font-bold text-white uppercase tracking-wider mb-1">Módulos</h2>
                            <p className="text-xs text-gray-500">{course.title}</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {course.modules.map((module) => (
                                <div key={module.id} className="mb-6">
                                    <h3 className="text-gray-400 text-xs font-bold uppercase mb-3 px-2 tracking-widest">{module.title}</h3>
                                    <div className="space-y-1">
                                        {module.lessons.map((lesson) => {
                                            const isActive = lesson.id === currentLessonId;
                                            return (
                                                <button key={lesson.id} onClick={() => onNavigate(module.id, lesson.id)} className={`w-full text-left p-3 rounded-md flex items-start group transition-all ${isActive ? 'bg-zinc-800 border-l-4 border-red-600' : 'hover:bg-zinc-800 border-l-4 border-transparent'}`}>
                                                    <div className="mr-3 mt-1 text-gray-500 group-hover:text-white">
                                                        {isActive ? <PlayCircle size={16} className="text-red-600" /> : <PlayCircle size={16} />}
                                                    </div>
                                                    <div>
                                                        <p className={`text-sm font-medium ${isActive ? 'text-white' : 'text-gray-300 group-hover:text-white'}`}>{lesson.title}</p>
                                                        <p className="text-xs text-gray-500 mt-1">{lesson.duration}</p>
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- AdminPanel Component (Simplificado para Single File) ---
        const AdminPanel = ({ courses, onAddCourse, onAddLesson, onAddModule, onEditModule, onDeleteModule, onEditLesson, onDeleteLesson, onClose }) => {
            const [selectedCourseId, setSelectedCourseId] = useState(courses[0]?.id || '');
            const [selectedModuleId, setSelectedModuleId] = useState('');
            const [isCreatingCourse, setIsCreatingCourse] = useState(courses.length === 0);
            
            // Campos de Formulário
            const [newCourseTitle, setNewCourseTitle] = useState('');
            const [newCourseDesc, setNewCourseDesc] = useState('');
            const [newCourseThumb, setNewCourseThumb] = useState('');
            const [newModuleTitle, setNewModuleTitle] = useState('');
            const [editingModuleId, setEditingModuleId] = useState(null);
            
            const [newLessonTitle, setNewLessonTitle] = useState('');
            const [newLessonUrl, setNewLessonUrl] = useState('');
            const [newLessonDesc, setNewLessonDesc] = useState('');
            const [newLessonDuration, setNewLessonDuration] = useState('');
            const [newLessonThumb, setNewLessonThumb] = useState('');
            const [editingLessonId, setEditingLessonId] = useState(null);
            const [videoSourceType, setVideoSourceType] = useState('url');

            const [isGenerating, setIsGenerating] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const activeCourse = courses.find(c => c.id === selectedCourseId);
            const activeModule = activeCourse?.modules.find(m => m.id === selectedModuleId);

            useEffect(() => {
                if (courses.length > 0 && !selectedCourseId) setSelectedCourseId(courses[0].id);
                if (courses.length === 0) setIsCreatingCourse(true);
            }, [courses]);

            const handleSubmitCourse = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                await onAddCourse({ id: crypto.randomUUID(), title: newCourseTitle, description: newCourseDesc, thumbnail: newCourseThumb, tags: [], modules: [] });
                setNewCourseTitle(''); setNewCourseDesc(''); setNewCourseThumb(''); setIsCreatingCourse(false); setIsSubmitting(false);
            };

            const handleSubmitModule = async (e) => {
                e.preventDefault();
                if (!selectedCourseId) return alert("Selecione um curso");
                setIsSubmitting(true);
                if (editingModuleId) {
                    await onEditModule(selectedCourseId, editingModuleId, { title: newModuleTitle });
                    setEditingModuleId(null); setNewModuleTitle('');
                } else {
                    await onAddModule(selectedCourseId, { id: crypto.randomUUID(), title: newModuleTitle, lessons: [] });
                    setNewModuleTitle('');
                }
                setIsSubmitting(false);
            };

            const handleGenerateMetadata = async () => {
                if (!newLessonTitle || !activeCourse) return;
                setIsGenerating(true);
                const details = await generateLessonDetails(newLessonTitle, activeCourse.title);
                setNewLessonDesc(details.description);
                setNewLessonDuration(details.durationEstimate);
                setIsGenerating(false);
            };

            const handleSubmitLesson = async (e) => {
                e.preventDefault();
                if (!selectedCourseId || !selectedModuleId) return;
                setIsSubmitting(true);
                const lessonData = {
                    title: newLessonTitle, description: newLessonDesc, videoUrl: newLessonUrl, duration: newLessonDuration, thumbnail: newLessonThumb
                };
                if (editingLessonId) {
                    await onEditLesson(selectedCourseId, selectedModuleId, editingLessonId, lessonData);
                    setEditingLessonId(null);
                } else {
                    await onAddLesson(selectedCourseId, selectedModuleId, { id: crypto.randomUUID(), ...lessonData });
                }
                // Limpar Form
                setNewLessonTitle(''); setNewLessonUrl(''); setNewLessonDesc(''); setNewLessonDuration(''); setNewLessonThumb('');
                setIsSubmitting(false);
            };

            // Helpers para UI
            const resetLessonForm = () => {
                setEditingLessonId(null); setNewLessonTitle(''); setNewLessonUrl(''); setNewLessonDesc(''); setNewLessonDuration(''); setNewLessonThumb('');
            };

            return (
                <div className="min-h-screen bg-black text-white p-4 md:p-8 pt-20">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-bold text-red-600">Admin</h1>
                            <button onClick={onClose}><X size={24} /></button>
                        </div>
                        
                        {/* Seção de Curso */}
                        <div className="bg-zinc-900 p-6 rounded mb-8 border border-zinc-800">
                            {isCreatingCourse ? (
                                <form onSubmit={handleSubmitCourse} className="space-y-4">
                                    <h2 className="font-bold flex gap-2"><PlusCircle /> Novo Curso</h2>
                                    <input placeholder="Título" value={newCourseTitle} onChange={e=>setNewCourseTitle(e.target.value)} className="w-full bg-zinc-800 p-2 rounded" required />
                                    <input placeholder="URL Capa" value={newCourseThumb} onChange={e=>setNewCourseThumb(e.target.value)} className="w-full bg-zinc-800 p-2 rounded" required />
                                    <textarea placeholder="Descrição" value={newCourseDesc} onChange={e=>setNewCourseDesc(e.target.value)} className="w-full bg-zinc-800 p-2 rounded" required />
                                    <button type="submit" disabled={isSubmitting} className="bg-white text-black p-2 rounded font-bold">Criar</button>
                                    {courses.length > 0 && <button onClick={()=>setIsCreatingCourse(false)} className="ml-4 text-sm text-gray-400">Cancelar</button>}
                                </form>
                            ) : (
                                <div className="flex gap-4">
                                    <div className="flex-1">
                                        <select value={selectedCourseId} onChange={e=>{setSelectedCourseId(e.target.value); setSelectedModuleId('');}} className="w-full bg-zinc-800 p-2 rounded text-white">
                                            {courses.map(c => <option key={c.id} value={c.id}>{c.title}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={()=>setIsCreatingCourse(true)} className="text-red-500 font-bold flex items-center gap-1"><PlusCircle size={16}/> Novo</button>
                                </div>
                            )}
                        </div>

                        {/* Grid Módulos e Aulas */}
                        <div className={`grid grid-cols-1 lg:grid-cols-2 gap-8 ${isCreatingCourse ? 'opacity-50 pointer-events-none' : ''}`}>
                            <div className="bg-zinc-900 p-6 rounded border border-zinc-800">
                                <h2 className="text-xl font-bold mb-4 text-red-500 flex items-center gap-2"><FolderPlus /> Módulos</h2>
                                <form onSubmit={handleSubmitModule} className="flex gap-2 mb-4">
                                    <input value={newModuleTitle} onChange={e=>setNewModuleTitle(e.target.value)} placeholder="Nome do Módulo" className="flex-1 bg-zinc-800 p-2 rounded" required />
                                    <button type="submit" className="bg-white text-black p-2 rounded font-bold">{editingModuleId ? <Save size={18}/> : <PlusCircle size={18}/>}</button>
                                </form>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {activeCourse?.modules.map(m => (
                                        <div key={m.id} onClick={()=>setSelectedModuleId(m.id)} className={`p-2 rounded flex justify-between cursor-pointer ${selectedModuleId===m.id ? 'bg-zinc-800 border-l-2 border-red-600' : 'bg-zinc-800/50'}`}>
                                            <span>{m.title}</span>
                                            <div className="flex gap-2">
                                                <button onClick={(e)=>{e.stopPropagation(); setEditingModuleId(m.id); setNewModuleTitle(m.title);}}><Edit2 size={14}/></button>
                                                <button onClick={(e)=>{e.stopPropagation(); onDeleteModule(selectedCourseId, m.id);}} className="text-red-500"><Trash2 size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-zinc-900 p-6 rounded border border-zinc-800">
                                <h2 className="text-xl font-bold mb-4 text-red-500 flex items-center gap-2"><Video /> Aulas</h2>
                                <form onSubmit={handleSubmitLesson} className="space-y-3">
                                    <select value={selectedModuleId} onChange={e=>setSelectedModuleId(e.target.value)} className="w-full bg-zinc-800 p-2 rounded" required>
                                        <option value="">Selecione Módulo</option>
                                        {activeCourse?.modules.map(m=><option key={m.id} value={m.id}>{m.title}</option>)}
                                    </select>
                                    <div className="flex gap-2">
                                        <input value={newLessonTitle} onChange={e=>setNewLessonTitle(e.target.value)} placeholder="Título da Aula" className="flex-1 bg-zinc-800 p-2 rounded" required />
                                        <button type="button" onClick={handleGenerateMetadata} disabled={isGenerating} className="bg-blue-600 p-2 rounded text-white">{isGenerating ? <Loader2 className="animate-spin"/> : <Sparkles/>}</button>
                                    </div>
                                    <div className="flex gap-2 text-xs">
                                        <button type="button" onClick={()=>setVideoSourceType('url')} className={`p-1 flex-1 ${videoSourceType==='url'?'bg-red-600':'bg-zinc-700'}`}>Link</button>
                                        <button type="button" onClick={()=>setVideoSourceType('embed')} className={`p-1 flex-1 ${videoSourceType==='embed'?'bg-red-600':'bg-zinc-700'}`}>Embed</button>
                                    </div>
                                    {videoSourceType === 'url' ? (
                                        <input type="url" value={newLessonUrl} onChange={e=>setNewLessonUrl(e.target.value)} placeholder="YouTube Link" className="w-full bg-zinc-800 p-2 rounded" />
                                    ) : (
                                        <textarea value={newLessonUrl} onChange={e=>setNewLessonUrl(e.target.value)} placeholder="<iframe>...</iframe>" className="w-full bg-zinc-800 p-2 rounded h-20 font-mono text-xs" />
                                    )}
                                    <input type="url" value={newLessonThumb} onChange={e=>setNewLessonThumb(e.target.value)} placeholder="URL Thumbnail (Opcional)" className="w-full bg-zinc-800 p-2 rounded" />
                                    <div className="flex gap-2">
                                        <textarea value={newLessonDesc} onChange={e=>setNewLessonDesc(e.target.value)} placeholder="Descrição" className="flex-1 bg-zinc-800 p-2 rounded h-20" />
                                        <input value={newLessonDuration} onChange={e=>setNewLessonDuration(e.target.value)} placeholder="00:00" className="w-24 bg-zinc-800 p-2 rounded h-10" />
                                    </div>
                                    <div className="flex gap-2">
                                        <button type="submit" disabled={isSubmitting} className="flex-1 bg-red-600 p-2 rounded font-bold">Salvar Aula</button>
                                        {editingLessonId && <button type="button" onClick={resetLessonForm} className="bg-zinc-700 p-2 rounded"><RotateCcw/></button>}
                                    </div>
                                </form>
                                
                                {activeModule && (
                                    <div className="mt-4 border-t border-zinc-800 pt-2 space-y-2 max-h-60 overflow-y-auto">
                                        {activeModule.lessons.map(l => (
                                            <div key={l.id} className="flex justify-between items-center text-sm p-2 bg-zinc-800/30 rounded">
                                                <span className="truncate flex-1">{l.title}</span>
                                                <div className="flex gap-2 ml-2">
                                                    <button onClick={()=>{setEditingLessonId(l.id); setNewLessonTitle(l.title); setNewLessonDesc(l.description); setNewLessonUrl(l.videoUrl); setNewLessonDuration(l.duration); setNewLessonThumb(l.thumbnail||''); if(l.videoUrl.startsWith('<')) setVideoSourceType('embed'); else setVideoSourceType('url');}}><Edit2 size={14}/></button>
                                                    <button onClick={()=>onDeleteLesson(selectedCourseId, activeModule.id, l.id)} className="text-red-500"><Trash2 size={14}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ------------------------------------------------------------------
        // 5. APP PRINCIPAL
        // ------------------------------------------------------------------
        const App = () => {
            const [courses, setCourses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState(ViewState.HOME);
            const [playerState, setPlayerState] = useState(null);

            // Fetch
            const fetchCourses = async () => {
                try {
                    const { data: coursesData, error } = await supabase.from('courses').select(`*, modules (*, lessons (*))`);
                    if (error) throw error;

                    if (coursesData) {
                        const formatted = coursesData.map(c => ({
                            id: c.id,
                            title: c.title,
                            description: c.description,
                            thumbnail: c.thumbnail,
                            heroImage: c.hero_image,
                            tags: c.tags || [],
                            modules: (c.modules || [])
                                .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())
                                .map(m => ({
                                    id: m.id,
                                    title: m.title,
                                    lessons: (m.lessons || [])
                                        .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())
                                        .map(l => ({
                                            id: l.id,
                                            title: l.title,
                                            description: l.description,
                                            videoUrl: l.video_url,
                                            duration: l.duration,
                                            thumbnail: l.thumbnail
                                        }))
                                }))
                        }));
                        setCourses(formatted);
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchCourses(); }, []);

            // Handlers (Simplificados)
            const handleAddCourse = async (c) => { 
                await supabase.from('courses').insert({ id: c.id, title: c.title, description: c.description, thumbnail: c.thumbnail, hero_image: c.thumbnail, tags: c.tags }); 
                fetchCourses(); 
            };
            const handleAddModule = async (cId, m) => {
                await supabase.from('modules').insert({ id: m.id, course_id: cId, title: m.title });
                fetchCourses();
            };
            const handleAddLesson = async (cId, mId, l) => {
                await supabase.from('lessons').insert({ id: l.id, module_id: mId, title: l.title, description: l.description, video_url: l.videoUrl, duration: l.duration, thumbnail: l.thumbnail });
                fetchCourses();
            };
            const onEditModule = async (cId, mId, data) => { await supabase.from('modules').update(data).eq('id', mId); fetchCourses(); }
            const onDeleteModule = async (cId, mId) => { if(confirm('Excluir módulo?')) await supabase.from('modules').delete().eq('id', mId); fetchCourses(); }
            const onEditLesson = async (cId, mId, lId, data) => { 
                await supabase.from('lessons').update({ title: data.title, description: data.description, video_url: data.videoUrl, duration: data.duration, thumbnail: data.thumbnail }).eq('id', lId); 
                fetchCourses(); 
            }
            const onDeleteLesson = async (cId, mId, lId) => { if(confirm('Excluir aula?')) await supabase.from('lessons').delete().eq('id', lId); fetchCourses(); }

            // Navegação
            const nav = (
                <nav className={`fixed top-0 w-full z-40 transition-all duration-300 ${view === ViewState.HOME ? 'bg-gradient-to-b from-black/80 to-transparent' : 'bg-black'}`}>
                    <div className="px-4 md:px-16 py-4 flex items-center justify-between">
                        <h1 className="text-red-600 text-3xl font-black cursor-pointer" onClick={() => setView(ViewState.HOME)}>METEFLIX</h1>
                        {view === ViewState.HOME && (
                             <button onClick={() => setView(ViewState.ADMIN)} className="text-gray-300 hover:text-white text-sm bg-zinc-800 px-3 py-1 rounded">Admin</button>
                        )}
                    </div>
                </nav>
            );

            if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-red-600 w-10 h-10"/></div>;

            if (view === ViewState.PLAYER && playerState) {
                const active = courses.find(c => c.id === playerState.courseId);
                if (!active) return null;
                return <VideoPlayer course={active} initialModuleId={playerState.moduleId} initialLessonId={playerState.lessonId} onBack={() => setView(ViewState.HOME)} onNavigate={(m, l) => setPlayerState({ ...playerState, moduleId: m, lessonId: l })} />;
            }

            if (view === ViewState.ADMIN) {
                return <AdminPanel courses={courses} onAddCourse={handleAddCourse} onAddModule={handleAddModule} onAddLesson={handleAddLesson} onEditModule={onEditModule} onDeleteModule={onDeleteModule} onEditLesson={onEditLesson} onDeleteLesson={onDeleteLesson} onClose={() => setView(ViewState.HOME)} />;
            }

            const featured = courses[0];

            return (
                <div className="min-h-screen text-white relative">
                    <div className="fixed inset-0 z-0 pointer-events-none">
                         <div className="absolute inset-0 bg-black/90"></div>
                    </div>
                    <div className="relative z-10">
                        {nav}
                        {featured ? (
                            <>
                                <Hero course={featured} />
                                <div className="pb-20 -mt-20 relative z-20">
                                    {featured.modules.map(m => (
                                        <CourseRow key={m.id} title={m.title} items={m.lessons} moduleId={m.id} onSelectLesson={(mId, lId) => { setPlayerState({ courseId: featured.id, moduleId: mId, lessonId: lId }); setView(ViewState.PLAYER); }} />
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className="h-screen flex flex-col items-center justify-center text-center">
                                <h2 className="text-2xl font-bold">Bem-vindo</h2>
                                <p className="mb-4">Nenhum curso encontrado.</p>
                                <button onClick={() => setView(ViewState.ADMIN)} className="bg-red-600 px-6 py-2 rounded">Painel Admin</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>